I"ÅV<hr />
<p>å®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ç®€å•çš„TCPé€šä¿¡ï¼Œ
ç½‘ç»œç¼–ç¨‹ä¸­æˆ‘ä»¬ä¸€èˆ¬ä¼šä½¿ç”¨ C/S æ¶æ„ï¼Œå³åŒ…å«æœåŠ¡å™¨ç«¯å’Œå®¢æˆ·ç«¯ã€‚</p>

<ul>
  <li>TCP ç½‘ç»œç¼–ç¨‹çš„æœåŠ¡å™¨ç«¯</li>
</ul>

<p>æœåŠ¡å™¨ç«¯ä¸€èˆ¬å…ˆç”¨ socket åˆ›å»ºä¸€ä¸ªå¥—æ¥å­—ï¼Œç„¶åç”¨ bind ç»™è¿™ä¸ªå¥—æ¥å­—ç»‘å®šåœ°å€ï¼ˆå³ ip+ç«¯å£å·ï¼‰ï¼Œç„¶åè°ƒç”¨ listen æŠŠè¿™ä¸ªå¥—æ¥å­—ç½®ä¸ºç›‘å¬çŠ¶æ€ï¼Œéšåè°ƒç”¨ accept å‡½æ•°ä»å·²å®Œæˆè¿æ¥é˜Ÿåˆ—ä¸­å–å‡ºæˆåŠŸå»ºç«‹è¿æ¥çš„å¥—æ¥å­—ï¼Œä»¥åå°±åœ¨è¿™ä¸ªæ–°çš„å¥—æ¥å­—ä¸Šè°ƒç”¨ sendã€recv æ¥å‘é€æ•°æ®ã€æ¥æ”¶æ•°æ®ï¼Œæœ€åè°ƒç”¨ close æ¥æ–­å¼€è¿æ¥é‡Šæ”¾èµ„æºå³å¯ã€‚</p>

<h3 id="servercpp">server.cpp</h3>
<h4 id="procedure">Procedure</h4>
<ol>
  <li>æ„é€ ä¸€ä¸ªå¥—æ¥å­—æè¿°ç¬¦ï¼›<br />
==&gt; <code class="language-plaintext highlighter-rouge">int socket(int domain, int type, int protocol);</code></li>
  <li>æ„é€ ä¸€ä¸ªç½‘ç»œåœ°å€Aä»¥å­˜å‚¨æœåŠ¡ç«¯åœ°å€ï¼›<br />
==&gt; <code class="language-plaintext highlighter-rouge">struct sockaddr_in;</code></li>
  <li>ç»‘å®šä¸Šè¿°å¥—æ¥å­—æè¿°ç¬¦å’Œç½‘ç»œåœ°å€Aï¼› <br />
==&gt; <code class="language-plaintext highlighter-rouge">int bind(int sock_fd, struct sockaddr * sock_addr, int addr_len);</code></li>
  <li>å°†å¥—æ¥å­—æè¿°ç¬¦ç½®äºç›‘å¬çŠ¶æ€ï¼›  <br />
==&gt; <code class="language-plaintext highlighter-rouge">int listen(int sock_fd, int backlog);</code></li>
  <li>æ„é€ ä¸€ä¸ªç½‘ç»œåœ°å€Bç”¨ä»¥å­˜å‚¨å®¢æˆ·ç«¯åœ°å€ï¼›  <br />
==&gt; <code class="language-plaintext highlighter-rouge">struct sockaddr_in;</code></li>
  <li>å°†ç”³è¯·ä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥çš„å®¢æˆ·ç«¯åœ°å€å­˜å‚¨åˆ°ç½‘ç»œåœ°å€Bä¸­ï¼Œå¹¶ä¸ºè¯¥å®¢æˆ·ç«¯å¥—æ¥å­—åˆ†é…æè¿°ç¬¦ï¼› <br />
==&gt; <code class="language-plaintext highlighter-rouge">int accept(int server_fd, struct sockaddr * sock_add, int* addr_len);</code></li>
  <li>å»ºç«‹ç¼“å†²åŒºï¼› <br />
==&gt; <code class="language-plaintext highlighter-rouge">char buffer[1000];</code></li>
  <li>åˆ›å»ºå¾ªç¯ï¼š
    <ol>
      <li>é‡æ–°åˆå§‹åŒ–ç¼“å†²åŒºï¼› <br />
==&gt; <code class="language-plaintext highlighter-rouge">void*  memset(void *s, int ch, size_t n);</code></li>
      <li>ä»å®¢æˆ·ç«¯è¯»å–æ•°æ®å­˜åˆ°ç¼“å†²åŒºä¸­ï¼› <br />
==&gt; <code class="language-plaintext highlighter-rouge">int recv(int cli_fd, void* buffer, size_t length, unsigned int flag);</code></li>
      <li>æ£€æŸ¥è¯»å–æ•°æ®é•¿åº¦ï¼Œåˆ¤æ–­å®¢æˆ·ç«¯æ˜¯å¦å‘å‡ºé€€å‡ºæç¤ºï¼›</li>
      <li>è¾“å‡ºå®¢æˆ·ç«¯æ•°æ®ï¼›</li>
    </ol>
  </li>
  <li>å…³é—­æœ¬è¿›ç¨‹æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¥—æ¥å­—æè¿°ç¬¦ï¼›  <br />
==&gt; <code class="language-plaintext highlighter-rouge">int close(int fd);</code></li>
</ol>

<h4 id="code">Code</h4>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/shm.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//1. æ„é€ ä¸€ä¸ªå¥—æ¥å­—æè¿°ç¬¦ï¼›</span>
    <span class="c1">//å®šä¹‰sockfd</span>
    <span class="kt">int</span> <span class="n">server_sockfd</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="cm">/*
        It's Ok to use PF_INET(Protocol Family) to initialize a socket as well as AF_INET(Address Family)
        int socket(int domain, int type, int Protocol);
        éœ€è¦æŒ‡æ˜ä½¿ç”¨çš„åè®®æ ˆï¼Œ æœåŠ¡ç±»å‹ï¼ˆæ•°æ®æŠ¥æœåŠ¡: SOCK_DGRAMï¼Œæ•°æ®æµæœåŠ¡: SOCK_STREAMï¼‰ï¼Œ
        ä½¿ç”¨çš„åè®®ï¼ˆä¸€èˆ¬å–0ï¼Œå³ç³»ç»Ÿé»˜è®¤ï¼‰; è¿”å›ä¸€ä¸ªæ•´å‹å³Socketæè¿°ç¬¦ã€‚
    */</span>

    <span class="c1">// 2. æ„é€ ä¸€ä¸ªç½‘ç»œåœ°å€Aä»¥å­˜å‚¨æœåŠ¡ç«¯åœ°å€ï¼›</span>
    <span class="c1">//å®šä¹‰sockaddr_in</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">server_sockaddr</span><span class="p">;</span>
    <span class="n">server_sockaddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span><span class="c1">//TCP/IPåè®®æ—</span>
    <span class="n">server_sockaddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">8023</span><span class="p">);</span><span class="c1">//ç«¯å£å· host to net, short; ä»ä¸»æœºå­—èŠ‚åºè½¬åŒ–ä¸ºç½‘ç»œå­—èŠ‚åº</span>
    <span class="n">server_sockaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">);</span><span class="c1">//ipåœ°å€ï¼Œ127.0.0.1æ˜¯ç¯å›åœ°å€ï¼Œç›¸å½“äºæœ¬æœºip</span>

    <span class="c1">//3. ç»‘å®šä¸Šè¿°å¥—æ¥å­—æè¿°ç¬¦å’Œç½‘ç»œåœ°å€Aï¼›</span>
    <span class="c1">//bindï¼ŒæˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1</span>
    <span class="k">if</span><span class="p">(</span><span class="n">bind</span><span class="p">(</span><span class="n">server_sockfd</span><span class="p">,(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">server_sockaddr</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">server_sockaddr</span><span class="p">))</span><span class="o">==-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"bind"</span><span class="p">);</span><span class="c1">//è¾“å‡ºé”™è¯¯åŸå› åˆ°stderr</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="c1">//ç»“æŸç¨‹åº</span>
    <span class="p">}</span>
    <span class="cm">/*
        int bind(int sock_fd, struct sockaddr * sock_adrr, int length);
        æŒ‡æ˜è¦ç»‘å®šçš„å¥—æ¥å­—ï¼Œåœ°å€ï¼Œåœ°å€é•¿åº¦
    */</span>

    <span class="c1">//4. å°†å¥—æ¥å­—æè¿°ç¬¦ç½®äºç›‘å¬çŠ¶æ€ï¼›</span>
    <span class="c1">//listenï¼ŒæˆåŠŸè¿”å›0ï¼Œå‡ºé”™è¿”å›-1</span>
    <span class="k">if</span><span class="p">(</span><span class="n">listen</span><span class="p">(</span><span class="n">server_sockfd</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"listen"</span><span class="p">);</span><span class="c1">//è¾“å‡ºé”™è¯¯åŸå› åˆ°stderr</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="c1">//ç»“æŸç¨‹åº</span>
    <span class="p">}</span>
    <span class="cm">/*
        int listen(int sock_fd, int backlog);
        å°†å¥—æ¥å­—ç½®äºç›‘å¬çŠ¶æ€ï¼Œbacklogä¸ºaccepté˜Ÿåˆ—é•¿åº¦
    */</span>

    <span class="c1">//5. æ„é€ ä¸€ä¸ªç½‘ç»œåœ°å€Bç”¨ä»¥å­˜å‚¨å®¢æˆ·ç«¯åœ°å€ï¼›</span>
    <span class="c1">//å®¢æˆ·ç«¯ç½‘ç»œåœ°å€</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">client_addr</span><span class="p">;</span>
    <span class="n">socklen_t</span> <span class="n">length</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client_addr</span><span class="p">);</span>

    <span class="c1">//6. å°†ç”³è¯·ä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥çš„å®¢æˆ·ç«¯åœ°å€å­˜å‚¨åˆ°ç½‘ç»œåœ°å€Bä¸­ï¼Œå¹¶ä¸ºè¯¥å®¢æˆ·ç«¯å¥—æ¥å­—åˆ†é…æè¿°ç¬¦ï¼›</span>
    <span class="c1">//æˆåŠŸè¿”å›éè´Ÿæè¿°å­—ï¼Œå‡ºé”™è¿”å›-1</span>
    <span class="kt">int</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">accept</span><span class="p">(</span><span class="n">server_sockfd</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">client_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">conn</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"connect"</span><span class="p">);</span><span class="c1">//è¾“å‡ºé”™è¯¯åŸå› </span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="c1">//ç»“æŸç¨‹åº</span>
    <span class="p">}</span>
    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">"å®¢æˆ·ç«¯æˆåŠŸè¿æ¥</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="cm">/*
        int accept(int server_sock_fd, struct sockaddr * client_addr, int * addr_length);
        æŒ‡æ˜æœåŠ¡å™¨å¥—æ¥å­—æè¿°ç¬¦ï¼Œç”¨äºå­˜æ”¾å®¢æˆ·ç«¯åœ°å€çš„åœ°å€ï¼Œåœ°å€é•¿åº¦, è¿”å›å®¢æˆ·ç«¯å¥—æ¥å­—æè¿°ç¬¦
    */</span>

    <span class="c1">//7. å»ºç«‹ç¼“å†²åŒºï¼›</span>
    <span class="c1">//æ¥æ”¶ç¼“å†²åŒº</span>
    <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1000</span><span class="p">];</span>

    <span class="c1">//8. åˆ›å»ºå¾ªç¯ï¼š</span>
    <span class="c1">//ä¸æ–­æ¥æ”¶æ•°æ®</span>
    <span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">//1. é‡æ–°åˆå§‹åŒ–ç¼“å†²åŒºï¼›</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
        <span class="c1">//2. ä»å®¢æˆ·ç«¯è¯»å–æ•°æ®å­˜åˆ°ç¼“å†²åŒºä¸­ï¼›</span>
        <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">recv</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
        <span class="c1">//3. æ£€æŸ¥è¯»å–æ•°æ®é•¿åº¦ï¼Œåˆ¤æ–­å®¢æˆ·ç«¯æ˜¯å¦å‘å‡ºé€€å‡ºæç¤ºï¼›</span>
        <span class="c1">//å®¢æˆ·ç«¯å‘é€exitæˆ–è€…å¼‚å¸¸ç»“æŸæ—¶ï¼Œé€€å‡º</span>
        <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span><span class="s">"exit"</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span> <span class="o">||</span> <span class="n">len</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="c1">//4. è¾“å‡ºå®¢æˆ·ç«¯æ•°æ®ï¼›</span>
        <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">"æ”¶åˆ°å®¢æˆ·ç«¯ä¿¡æ¯ï¼š"</span><span class="o">&lt;&lt;</span><span class="n">buffer</span><span class="o">&lt;&lt;</span><span class="n">endl</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/*
        int recv(int sock_fd, void* buffer, int buff_len, unsigned int flag);
        æŒ‡æ˜å¥—æ¥å­—æè¿°ç¬¦ï¼Œç”¨äºå­˜æ”¾çš„ç¼“å­˜åœ°å€ï¼Œç¼“å­˜åŒºå¤§å°ï¼Œflagé»˜è®¤0ï¼Œè¿”å›æ¥æ”¶åˆ°çš„æ•°æ®é•¿åº¦ 
    */</span>
    <span class="c1">//9. å…³é—­æœ¬è¿›ç¨‹æœåŠ¡ç«¯å’Œå®¢æˆ·ç«¯å¥—æ¥å­—æè¿°ç¬¦</span>
    <span class="n">close</span><span class="p">(</span><span class="n">conn</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">server_sockfd</span><span class="p">);</span>
    <span class="c1">// å¯èƒ½ä¼šæœ‰å¤šä¸ªè¿›ç¨‹å…±äº«åŒä¸€ä¸ªå¥—æ¥å­—ï¼Œcloseä¼šå°†å¥—æ¥å­—çš„å¼•ç”¨å‡ä¸€ï¼Œå½“å¼•ç”¨æ•°é‡ä¸º0æ—¶ï¼Œå…³é—­è¿æ¥å¹¶æ’¤é”€å…³é”®å­—</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<ul>
  <li>TCP ç½‘ç»œç¼–ç¨‹çš„å®¢æˆ·ç«¯</li>
</ul>

<p>ä¸æœåŠ¡å™¨ä¸åŒï¼Œå®¢æˆ·ç«¯å¹¶ä¸éœ€è¦ bind ç»‘å®šåœ°å€ï¼Œå› ä¸ºç«¯å£å·æ˜¯ç³»ç»Ÿè‡ªåŠ¨åˆ†é…çš„ï¼Œè€Œä¸”å®¢æˆ·ç«¯ä¹Ÿä¸éœ€è¦è®¾ç½®ç›‘å¬çš„å¥—æ¥å­—ï¼Œå› æ­¤ä¹Ÿä¸éœ€è¦ listenã€‚å®¢æˆ·ç«¯åœ¨ç”¨ socket åˆ›å»ºå¥—æ¥å­—åç›´æ¥è°ƒç”¨ connect å‘æœåŠ¡å™¨å‘èµ·è¿æ¥å³å¯ï¼Œconnect å‡½æ•°é€šçŸ¥ Linux å†…æ ¸å®Œæˆ TCP ä¸‰æ¬¡æ¡æ‰‹è¿æ¥ï¼Œæœ€åæŠŠè¿æ¥çš„ç»“æœä½œä¸ºè¿”å›å€¼ã€‚æˆåŠŸå»ºç«‹è¿æ¥åæˆ‘ä»¬å°±å¯ä»¥è°ƒç”¨ send å’Œ recv æ¥å‘é€æ•°æ®ã€æ¥æ”¶æ•°æ®ï¼Œæœ€åè°ƒç”¨ close æ¥æ–­å¼€è¿æ¥é‡Šæ”¾èµ„æºã€‚</p>

<h3 id="clientcpp">client.cpp</h3>
<h4 id="procedure-1">Procedure</h4>
<ol>
  <li>åˆ›å»ºå®¢æˆ·ç«¯å¥—æ¥å­—æè¿°ç¬¦ï¼›  <br />
==&gt; <code class="language-plaintext highlighter-rouge">int socket(int domain, int type, int protocol);</code></li>
  <li>åˆ›å»ºç½‘ç»œåœ°å€å¹¶åˆå§‹åŒ–ä¸ºæœåŠ¡ç«¯ç½‘ç»œåœ°å€ï¼›  <br />
==&gt; <code class="language-plaintext highlighter-rouge">struct sockaddr_in;</code></li>
  <li>ç”³è¯·åˆ›å»ºå®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„è¿æ¥ï¼› <br />
==&gt; <code class="language-plaintext highlighter-rouge">int connect(int client_fd, struct sockaddr_in * server_addr, size_t addr_len);</code></li>
  <li>åˆ›å»ºå‘é€ç¼“å†²åŒºï¼›  <br />
==&gt; <code class="language-plaintext highlighter-rouge">char buffer[1000];</code></li>
  <li>åˆ›å»ºå¾ªç¯ï¼š
    <ol>
      <li>é‡ç½®å‘é€ç¼“å†²åŒºï¼› <br />
==&gt; <code class="language-plaintext highlighter-rouge">void* memset(void* s, int ch, size_t n);</code></li>
      <li>è·å–å¤–éƒ¨è¾“å…¥åˆ°å‘é€ç¼“å†²åŒºï¼›</li>
      <li>å°†å‘é€ç¼“å†²åŒºå†…å®¹å†™å…¥å®¢æˆ·ç«¯å¥—æ¥å­—æè¿°ç¬¦ï¼› <br />
==&gt; <code class="language-plaintext highlighter-rouge">int send(int client_fd, const void* buffer, size_t length);</code></li>
      <li>åˆ¤æ–­æ˜¯å¦è¾“å…¥â€œexitâ€ï¼›</li>
    </ol>
  </li>
  <li>å…³é—­æœ¬è¿›ç¨‹å®¢æˆ·ç«¯å¥—æ¥å­—æè¿°ç¬¦ï¼› <br />
==&gt; <code class="language-plaintext highlighter-rouge">int close(int fd);</code></li>
</ol>

<h4 id="code-1">Code</h4>
<div class="language-c++ highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;sys/types.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/socket.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;netinet/in.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;arpa/inet.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;unistd.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;string.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;fcntl.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;sys/shm.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;iostream&gt;</span><span class="cp">
</span><span class="k">using</span> <span class="k">namespace</span> <span class="n">std</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">// 1. åˆ›å»ºå®¢æˆ·ç«¯å¥—æ¥å­—æè¿°ç¬¦ï¼›</span>
    <span class="c1">//å®šä¹‰sockfd</span>
    <span class="kt">int</span> <span class="n">sock_cli</span> <span class="o">=</span> <span class="n">socket</span><span class="p">(</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">SOCK_STREAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="c1">// 2. åˆ›å»ºç½‘ç»œåœ°å€å¹¶åˆå§‹åŒ–ä¸ºæœåŠ¡ç«¯ç½‘ç»œåœ°å€ï¼›</span>
    <span class="c1">//å®šä¹‰sockaddr_in</span>
    <span class="k">struct</span> <span class="nc">sockaddr_in</span> <span class="n">servaddr</span><span class="p">;</span>
    <span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">));</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_family</span> <span class="o">=</span> <span class="n">AF_INET</span><span class="p">;</span><span class="c1">//TCP/IPåè®®æ—</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_port</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="mi">8023</span><span class="p">);</span>  <span class="c1">//æœåŠ¡å™¨ç«¯å£</span>
    <span class="n">servaddr</span><span class="p">.</span><span class="n">sin_addr</span><span class="p">.</span><span class="n">s_addr</span> <span class="o">=</span> <span class="n">inet_addr</span><span class="p">(</span><span class="s">"127.0.0.1"</span><span class="p">);</span>  <span class="c1">//æœåŠ¡å™¨ip</span>

    <span class="c1">// 3. ç”³è¯·åˆ›å»ºå®¢æˆ·ç«¯åˆ°æœåŠ¡ç«¯çš„è¿æ¥;</span>
    <span class="c1">//è¿æ¥æœåŠ¡å™¨ï¼ŒæˆåŠŸè¿”å›0ï¼Œé”™è¯¯è¿”å›-1</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">connect</span><span class="p">(</span><span class="n">sock_cli</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="nc">sockaddr</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">servaddr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">servaddr</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">perror</span><span class="p">(</span><span class="s">"connect"</span><span class="p">);</span>
        <span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">cout</span><span class="o">&lt;&lt;</span><span class="s">"è¿æ¥æœåŠ¡å™¨æˆåŠŸï¼</span><span class="se">\n</span><span class="s">"</span><span class="p">;</span>
    <span class="cm">/*
        int connect(int cli_sock_fd, struct sockaddr * ser_addr, int addr_len);
    */</span>

    <span class="c1">// 4. åˆ›å»ºå‘é€ç¼“å†²åŒºï¼›</span>
    <span class="kt">char</span> <span class="n">sendbuf</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
    <span class="kt">char</span> <span class="n">recvbuf</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
    <span class="c1">// 5. åˆ›å»ºå¾ªç¯ï¼š</span>
    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
       <span class="c1">// 1. é‡ç½®å‘é€ç¼“å†²åŒºï¼›</span>
        <span class="n">memset</span><span class="p">(</span><span class="n">sendbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sendbuf</span><span class="p">));</span>
       <span class="c1">// 2. è·å–å¤–éƒ¨è¾“å…¥åˆ°å‘é€ç¼“å†²åŒºï¼›</span>
        <span class="n">cin</span><span class="o">&gt;&gt;</span><span class="n">sendbuf</span><span class="p">;</span>
       <span class="c1">// 3. å°†å‘é€ç¼“å†²åŒºå†…å®¹å†™å…¥å®¢æˆ·ç«¯å¥—æ¥å­—æè¿°ç¬¦ï¼›</span>
        <span class="n">send</span><span class="p">(</span><span class="n">sock_cli</span><span class="p">,</span> <span class="n">sendbuf</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">sendbuf</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span> <span class="c1">//å‘é€</span>
       <span class="c1">// 4. åˆ¤æ–­æ˜¯å¦è¾“å…¥â€œexitâ€ï¼›</span>
        <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sendbuf</span><span class="p">,</span><span class="s">"exit"</span><span class="p">)</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="c1">// 6. å…³é—­æœ¬è¿›ç¨‹å®¢æˆ·ç«¯å¥—æ¥å­—æè¿°ç¬¦ï¼›</span>
    <span class="n">close</span><span class="p">(</span><span class="n">sock_cli</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div>

<p>ä¸‹ä¸€ç¯‡ï¼š<a href="/æœåŠ¡ç«¯(å¤šçº¿ç¨‹,-é¢å‘å¯¹è±¡)">æœåŠ¡ç«¯(å¤šçº¿ç¨‹, é¢å‘å¯¹è±¡)</a></p>

:ET